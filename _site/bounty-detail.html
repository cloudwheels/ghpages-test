<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=ceeb0f48214357cd37b6d2eb60fa20b5fb1fd074">
    <meta property="og:image" content="https://cloudwheels.github.io/ghpages-test/assets/image/incubator-logo.jpg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
let boardId = 'D5wypdJ0';
const DASHUSD =  75.0;
</script>
    <script>

    jQuery.support.cors = true;

    async function getTrelloAllData(args) {
        let result;

        try {
            result = await $.ajax({
                type: "GET",
                url: 'https://api.trello.com/1/board/B5wypdJ0/cards?checklists=all&fields=id,name,idList,shortUrl,desc&customFieldItems=true&members=true&member_fields=username&key=910955be8cf85efce2eb715fea302f2b',
                data: "{}",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                cache: false,
            });

            return result;
        } catch (error) {
            console.error(error);
        }
    }

    function transformTrelloData(data) {
        //got all card data
        //console.log('Got all card data:');
        //console.dir(data);

        //remove any cards from the concepts list and archive list
        const listIdConcepts = '5f6f3b657a973a233675ae09';
        const listIdArchive = '5f6f3be749ba1e07429a82a5';

        let removedConcepts = data.filter(item => item.idList !== listIdConcepts && item.idList !== listIdArchive);

        //only get cards with checklists
        let withChecklists = removedConcepts.filter(item => item.checklists.length > 0);

        //process checklist items into array of task objects
        let tasks = [];
        withChecklists.map(card => {

            let cardId = card.id;
            let cardName = card.name;
            let cardDesc = card.desc;
            let listId = card.idList;
            let cardUrl = card.shortUrl;
            let cardAdmin = null;
            if (card.members.length > 0) {
                cardAdmin = card.members[0].username;
            }
            let cardCustomFields = processCustomFields(card.customFieldItems);
            card.checklists.map(checklist => {
                let checklistName = checklist.name;
                //We don't need Concept Tasks
                if (checklistName != 'Concept Tasks') {
                    checklist.checkItems.map(checklistItem => {

                        let checklistItemIdMember = checklistItem.idMember;

                        //only bother adding if it doesn't have an assigned member
                        if (checklistItemIdMember == null) {
                            let taskId = checklistItem.id;
                            let checklistItemName = checklistItem.name;
                            let parsedDesc = splitTaskDescription(checklistItemName);
                            console.log('parsedDesc', parsedDesc);
                            let taskNumber = parsedDesc.taskNumber;
                            let taskDesc = parsedDesc.taskDesc
                            //let extractedDashAmount = parsedDesc.amt; //extractReward(checklistItemName);
                            //convert to USD 
                            //TODO: Use live rates
                            let dashAmountFloat = parsedDesc.taskRewardDash;
                            let dashUSDAmount = null;
                            if (dashAmountFloat !== null) {
                                //dashAmountFloat = parseFloat(extractedDashAmount);
                                //TODO error handling
                                dashUSDAmount = dashAmountFloat * DASHUSD;
                            }

                            tasks.push({ taskId: taskId, taskNumber: taskNumber, cardId: cardId, cardName: cardName, cardDesc: cardDesc, listId: listId, cardUrl: cardUrl, admin: cardAdmin, workType: cardCustomFields.workType, cardSkills: cardCustomFields.skills, checklistName: checklistName, checklistItemName: checklistItemName, taskDesc: taskDesc, rewardDash: dashAmountFloat, rewardUSD: dashUSDAmount });
                        }
                    })
                }

            })

        })

        //console.log('all Tasks:');
        //console.dir(tasks);

        let totalTasks = tasks.length;
        console.log('total tasks:', totalTasks)

        //filter tasks to lists
        let lists = {}

        lists.project = tasks.filter(item => item.checklistName == 'Work Tasks' && item.workType == 'Project');
        lists.spec = tasks.filter(item => item.checklistName == 'Specification Tasks');
        lists.service = tasks.filter(item => item.checklistName == 'Work Tasks' && item.workType == 'Service');
        lists.job = tasks.filter(item => item.checklistName == 'Work Tasks' && item.workType == 'Job');
        lists.qa = tasks.filter(item => item.checklistName == 'QA Tasks');


        console.log('Lists:');
        console.dir(lists);

        return lists;

    }



    function processCustomFields(arrCustomFields) {
        //accepts an array of custom fields from card data
        //returns an object containing Work Type & Skills
        //constants for custom fields
        const customFieldWorkTypeId = '5f7dd2a9bd811d5f1437b453';
        const customFieldWorkTypeValueProject = '5f7dd2beb8da6c565657f42d';
        const customFieldWorkTypeValueService = '5f7dd2c01b60a744c58c41cd';
        const customFieldWorkTypeValueJob = '5f7dd2c27b967f3da54ba1bc';

        const customFieldSkillsId = '5f887cf52b330a6b74bd592b';

        let customFields = {};

        //get workType
        arrCustomFields.filter(field => field.idCustomField == customFieldWorkTypeId)
            .map(value => {
                switch (value.idValue) {
                    case customFieldWorkTypeValueProject:
                        customFields.workType = 'Project'
                        break;
                    case customFieldWorkTypeValueService:
                        customFields.workType = 'Service'
                        break;
                    case customFieldWorkTypeValueJob:
                        customFields.workType = 'Job'
                        break;
                    default: customFields.workType = null;
                }
            });

        //get Skills

        filterSkills = arrCustomFields.filter(field => field.idCustomField == customFieldSkillsId)
        if (filterSkills.length > 0) {
            filterSkills.map(value => {
                customFields.skills = value.value.text;
            });
        }
        else {
            customFields.skills = null;
        }
        return customFields;

    }


    function splitTaskDescription(strTaskDescription) {


        try{

        let firstRBracket = strTaskDescription.indexOf(")");

        //task number
        let taskNumber = strTaskDescription.substr(0, firstRBracket);

        //extracts Dash Reward amount from task description
        //get last parenthesised text
        let lastLBracket = strTaskDescription.lastIndexOf("(");
        //console.log('lastLBracket',lastLBracket);
        let lastRBracket = strTaskDescription.lastIndexOf(")");
        //console.log('lastRBracket',lastRBracket);


        let taskDesc = strTaskDescription.substr(firstRBracket + 1, lastLBracket - firstRBracket - 1).trim();

        //replace md links with html <a> link
        let elements = taskDesc.match(/\[.*?\)/g);
        if (elements != null && elements.length > 0) {
            for (el of elements) {
                let txt = el.match(/\[(.*?)\]/)[1];//get only the txt
                let url = el.match(/\((.*?)\)/)[1];//get only the link
                taskDesc = taskDesc.replace(el, '<a href="' + url + '" target="_blank">' + txt + '</a>')
            }
        }


        let lastBracketContent = strTaskDescription.substr(lastLBracket + 1, lastRBracket - lastLBracket - 1).trim().toUpperCase();
        //console.log('lastBracketContent',lastBracketContent);
        let posOfTextDash = lastBracketContent.indexOf("DASH");
        //console.log('posOfTextDash',posOfTextDash);
        let amountStr = lastBracketContent.substr(0, posOfTextDash).trim()
        //console.log('amountStr',amountStr);
        // TODO: $.isNumeric is DEPRECATED!
        // replace with pure JS implementation
        let amt = null
        if ($.isNumeric(amountStr)) {
            amt = parseFloat(amountStr) ;
        }
        return { taskNumber: taskNumber, taskDesc: taskDesc, taskRewardDash: amt }
    }
    catch(e){
        console.log(e);
        //throw e
        return  { taskNumber: null, taskDesc: null, rewardDash: null }

    }

    }


    function extractReward(strTaskDescription) {
        //extracts Dash Reward amount from task description
        //get last parenthesised text
        let lastLBracket = strTaskDescription.lastIndexOf("(");
        //console.log('lastLBracket',lastLBracket);
        let lastRBracket = strTaskDescription.lastIndexOf(")");
        //console.log('lastRBracket',lastRBracket);
        let lastBracketContent = strTaskDescription.substr(lastLBracket + 1, lastRBracket - lastLBracket - 1).trim().toUpperCase();
        //console.log('lastBracketContent',lastBracketContent);
        let posOfTextDash = lastBracketContent.indexOf("DASH");
        //console.log('posOfTextDash',posOfTextDash);
        let amountStr = lastBracketContent.substr(0, posOfTextDash).trim()
        //console.log('amountStr',amountStr);
        // TODO: $.isNumeric is DEPRECATED!
        // replace with pure JS implementation
        if ($.isNumeric(amountStr)) {
            return amountStr;
        }
        else {
            return null;
        }

    }

    function listToTable(tableId, projectHeaderName, data) {
        let strHTML = '';

        strHTML += `
    <table class="bounty-table" id="tbl_${tableId}">
                    <thead>
                        <tr>
                            <th>${projectHeaderName}</th>
                            <th>
                                Task #
                            </th>
                            <th>
                                Task Description
                            </th>
                            <th>Skills</th>
                            <th>Reward</th>
                        </tr>
                    </thead>
                    <tbody>
    `
        data.map(item => {
            //let link = `./bounty-detail.html?bountytaskid=${item.taskId}&bountytrellourl=${item.cardUrl}&bountyname=${item.checklistItemName}&bountycardname=${item.cardName}&bountycarddesc=${item.cardDesc}&bountyrewardusd=${item.rewardUSD}&bountyrewarddash=${item.rewardDash}&bountyadmin=${item.admin}&bountyworktype=${item.workType}`;
            let link = `./bounty-detail.html?taskid=${item.taskId}`;
            strHTML += `<tr><td><div>${item.cardName}</div></td><td><div>${item.taskNumber}</div></td><td><div>${item.taskDesc}</div></td><td><div>${item.cardSkills || ''}</div></td><td><div><a href="${link}" class="btn">${item.rewardDash} Dash ($${item.rewardUSD})</a></div></td></tr>`;
        });

        strHTML += `
                    </tbody>
                    </table>
    `

        return strHTML;



    }

    function urlParam(name) {
        var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
        if (results == null) {
            return null;
        }
        return decodeURI(results[1]) || 0;
    }


    function getTaskById(data, taskId) {
        taskData = data.filter(item => item.taskId == taskId);
        console.log(`data for task id ${taskId}`, taskData)
        return taskData
    }

    function bountyDetailInfo(workType) {
        //chnage link to rules depending on worktype
        let reservingAnchor = '221-reserving-a-task';
        let rulesAnchor = '';
        let linkText = '<a href="rules.html">Find out more about tasks</a>';
        switch (workType.toUpperCase()) {
            case 'SPEC':
                rulesAnchor = '32-specifications';
                linkText = `<a href="rules.html#${rulesAnchor}">creating specifications.</a>`;
                break;
            case 'PROJECT':
                rulesAnchor = '33-projects';
                linkText = `<a href="rules.html#${rulesAnchor}">and completing project tasks.</a>`;
                break;
            case 'SERVICE':
                rulesAnchor = '34-services';
                linkText = `<a href="rules.html#${rulesAnchor}">and completing service tasks.</a>`;
                break;
            case 'JOB':
                rulesAnchor = '35-jobs';
                linkText = `<a href="rules.html#${rulesAnchor}">and completing job tasks.</a>`;
                break;
            case 'QA':
                rulesAnchor = '36-qa';
                linkText = `<a href="rules.html#${rulesAnchor}">and completing QA tasks.</a>`;
                break;


        }

        let strInfoLink = `Learn more about <a href="rules.html#${reservingAnchor}">reserving tasks</a> and ${linkText}`
        return strInfoLink;
    }
</script>
    
    <script>window.twttr = (function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0],
        t = window.twttr || {};
      if (d.getElementById(id)) return t;
      js = d.createElement(s);
      js.id = id;
      js.src = "https://platform.twitter.com/widgets.js";
      fjs.parentNode.insertBefore(js, fjs);
    
      t._e = [];
      t.ready = function(f) {
        t._e.push(f);
      };
    
      return t;
    }(document, "script", "twitter-wjs"));</script>
  
    <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Dash Incubator | Claim bounties for new ideas, specifying and working on tasks, and carring out QA on Dash blockchain software.</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Dash Incubator" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Claim bounties for new ideas, specifying and working on tasks, and carring out QA on Dash blockchain software." />
<meta property="og:description" content="Claim bounties for new ideas, specifying and working on tasks, and carring out QA on Dash blockchain software." />
<link rel="canonical" href="http://localhost:4000/bounty-detail.html" />
<meta property="og:url" content="http://localhost:4000/bounty-detail.html" />
<meta property="og:site_name" content="Dash Incubator" />
<script type="application/ld+json">
{"description":"Claim bounties for new ideas, specifying and working on tasks, and carring out QA on Dash blockchain software.","url":"http://localhost:4000/bounty-detail.html","@type":"WebPage","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/image/incubator-logo.jpg"}},"headline":"Dash Incubator","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>
    <div class="nav-container">
        <div class="top-nav"><a href="http://localhost:4000/index.html" class="top-nav-border">Bounties</a><a href="http://localhost:4000/rules.html#23-rewards-list"
                        class="top-nav-border">Rewards</a><a href="http://localhost:4000/rules.html" class="top-nav-border">Rules</a><a href="http://localhost:4000/blog.html">Blog</a></div>
        <div class="nav-corner">
                <a href="https://github.com/dashincubator" target="_blank"><img src="http://localhost:4000/assets/image/github-1.svg" alt="Dash Incubator on GitHub"></a>
                <a href="https://twitter.com/dashincubator" target="_blank"><img src="http://localhost:4000/assets/image/twitter.svg" alt="Dash Incubator on Twitter"></a>
                <a href="http://chat.dashdevs.org" target="_blank"><img src="http://localhost:4000/assets/image/discord.svg" alt="Chat on the Dash Dev Discord"></a>
                <a href="http://dash.org" target="_blank"><img src="http://localhost:4000/assets/image/white-d.svg" alt="More about Dash"></a>
        </div>
        <a href="./"><img class="nav-logo" src="http://localhost:4000/assets/image/logo.png" alt="incubator logo"></a>
</div>
    <div class="container">
      <section id="main_content">
        <div id="fb-root"></div>
<script async="" defer="" crossorigin="anonymous" src="https://connect.facebook.net/en_GB/sdk.js#xfbml=1&amp;version=v8.0" nonce="3TY5c3bh"></script>

<script>
    $(document).ready(async function () {

    let detailsTemplate =`<table>
    <tr>
        <td class="bounty-item-title">Project</td>
        <td>
            <div id="bounty-info-project"></div>
        </td>
    </tr>
    <tr>
        <td class="bounty-item-title">Project Description</td>
        <td>
            <div id="bounty-info-desc"></div>
        </td>
    </tr>
    <tr>
        <td class="bounty-item-title">Task #</td>
        <td>
            <div id="bounty-info-tasknumber"></div>
        </td>
    </tr>
    <tr>
        <td class="bounty-item-title">Task Description</td>
        <td>
            <div id="bounty-info-name"></div>
        </td>
    </tr>
    <tr>
        <td class="bounty-item-title">Reward</td>
        <td>
            <div id="bounty-info-reward"></div>
        </td>
    </tr>
    <tr>
        <td class="bounty-item-title">Work Type</td>
        <td>
            <div id="bounty-info-worktype"></div>
        </td>
    </tr>
    <tr>
        <td class="bounty-item-title">Admin</td>
        <td>
            <div id="bounty-info-admin"></div>
        </td>
    </tr>
    <tr>
        <td class="bounty-item-title">Status</td>
        <td>
            <div id="bounty-info-status"></div>
            Available
        </td>
    </tr>
</table>
<div id="trello-instructions">
<div id="rules-explanation">
</div>
<div id="bounty-info-trellolink"></div>
</div>
<div id="rules-link"></div>
<br>`

        //get all data
        $('#loading-data').show();
        
        try{
        let data = await getTrelloAllData();
        $('#loading-data').hide();
        let lists = transformTrelloData(data);
        let taskData = lists.project.concat(lists.spec, lists.service, lists.job, lists.qa);
        let taskId = decodeURIComponent(urlParam('taskid'));

        let foundTasks = getTaskById(taskData, taskId);

        if(foundTasks.length===1){

        $('#bounty-details').append(detailsTemplate);

        let task = foundTasks[0];

        let workType = task.workType;
        let taskNumber = task.taskNumber

        $('#bounty-info-project').append(task.cardName);
        $('#bounty-info-name').append(task.taskDesc);
        $('#bounty-info-tasknumber').append(taskNumber);   
        $('#bounty-info-desc').append(task.cardDesc);
        $('#bounty-info-admin').append(task.admin);
        $('#bounty-info-worktype').append(workType);
        $('#bounty-info-reward').append(task.rewardDash + ' Dash ($' + task.rewardUSD + ')');
        $('#trello-instructions').prepend(`To request to reserve this ${workType} Task, add this comment on the trello card :<br>`);
        $('#rules-explanation').append(`I want to reserve ${workType} Task #${taskNumber}`)
        var trellolink = task.cardUrl;      
        $('#bounty-info-trellolink').append('<a id="reserve-button" class="btn" href="' + trellolink + '">RESERVE BOUNTY</a>');
        let strInfoLink = bountyDetailInfo(workType);
        $('#rules-link').append(strInfoLink);
        let encodedLink = encodeURIComponent(window.location.href);
        console.log('encoded link', encodedLink);

        let twitterText = 'Claim bounty rewards for helping to build Dash blockchain software - check out this task:';
        
        let encodedText = encodeURIComponent(twitterText);
        encodedText = twitterText.replace("%20", "%2520");
        let twitterUrl = `https://twitter.com/intent/tweet?url=${encodedLink}&text=${encodedText}`;
        let twitterButton = `<a class="twitter-share-button"
    href="${twitterUrl}">Tweet</a>`
        $('#tweet-button').append(twitterButton);
        }
        
        else {
            $('#bounty-details').append(`<p>Sorry, this bounty id couldn't be found. It may already be reserved. Check the main bounties page for other opportunities</p>`);
            $('#page-share').prepend(`<p>Find other opportunities to share with friends on the bounties page</p>`)
        }
        }
        catch(e){
                $('#loading-data').css("background-color","red");
                $('#loading-data').text(`There was an error loading the data: ${e}`);
                $('#loading-data').show();
        }
    })




</script>

<h1>Bounty Details</h1>
<div id="page-share" class="page_share">
<div class="fb-share-button" data-layout="button" data-size="small"><a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fdevelopers.facebook.com%2Fdocs%2Fplugins%2F&amp;src=sdkpreparse" class="fb-xfbml-parse-ignore">Share</a></div>
<div id="tweet-button"></div>
</div>
<p><br /></p>
<div id="bounty-details"></div>

<div id="concept-info">
<h3>Get rewards for your ideas!</h3>
Learn more about <a href="rules.html#31-concepts">creating concepts</a>
</div>

<div id="loading-data" style="display:none;">Loading data...</div>

      </section>
    </div>

    
  </body>
</html>
